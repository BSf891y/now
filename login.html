// Global variables
const SHEET_ID = "13YQtVVTAzbuhbCN04_31ssgJHLxKzf75BJ6KnBOt0";
const SALT_LENGTH = 16;
const USER_PROPS = PropertiesService.getUserProperties();

// Handle OPTIONS requests (required for CORS)
function doOptions(e) {
  return ContentService.createTextOutput(JSON.stringify({status: "success"}))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}

// Handle GET requests with CORS headers
function doGet(e) {
  return createResponse(handleRequest(e));
}

// Handle POST requests with CORS headers
function doPost(e) {
  return createResponse(handleRequest(e));
}

// Function to handle both GET and POST requests
function handleRequest(e) {
  try {
    Logger.log("Received request: " + JSON.stringify(e));
    let params = extractParams(e);
    const action = params.action;
    
    if (!action) {
      return { status: 'error', message: 'Missing action parameter' };
    }

    switch (action) {
      case 'test':
        return { status: 'success', message: 'API is working!', timestamp: new Date().toISOString() };
      case 'login':
        return handleLogin(params);
      case 'register':
        return handleRegister(params);
      default:
        return { status: 'error', message: 'Invalid action. Supported actions: login, register, test' };
    }
  } catch (error) {
    Logger.log("Error in handleRequest: " + error);
    return { status: 'error', message: 'Server error: ' + error.message };
  }
}

// Extract parameters from request
function extractParams(e) {
  let params = {};
  try {
    if (e.postData && e.postData.contents) {
      params = JSON.parse(e.postData.contents);
    } else {
      params = e.parameter;
    }
  } catch (error) {
    Logger.log("Error parsing parameters: " + error);
  }
  return params;
}

// Create a consistent response format
function createResponse(response) {
  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}

// Handle login requests
function handleLogin(params) {
  try {
    const { username, password } = params;
    if (!username || !password) {
      return { status: 'error', message: 'Username and password are required' };
    }
    
    const sheet = getSheet('Users');
    if (!sheet) return { status: 'error', message: 'User data unavailable' };
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) return { status: 'error', message: 'Authentication failed' };
    
    const headers = data[0];
    const usernameCol = headers.indexOf('username');
    const passwordCol = headers.indexOf('password');
    if (usernameCol === -1 || passwordCol === -1) return { status: 'error', message: 'Invalid user database' };
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][usernameCol] === username && data[i][passwordCol] === password) {
        return { status: 'success', message: 'Login successful', token: Utilities.getUuid() };
      }
    }
    return { status: 'error', message: 'Invalid username or password' };
  } catch (error) {
    Logger.log("Login error: " + error);
    return { status: 'error', message: 'Authentication failed' };
  }
}

// Handle register requests
function handleRegister(params) {
  try {
    const { username, password } = params;
    if (!username || !password) {
      return { status: 'error', message: 'Username and password are required' };
    }
    
    const sheet = getSheet('Users', true);
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const usernameCol = headers.indexOf('username');
    
    if (usernameCol === -1) return { status: 'error', message: 'Invalid user database' };
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][usernameCol] === username) {
        return { status: 'error', message: 'Username already exists' };
      }
    }
    
    sheet.appendRow([username, password]);
    return { status: 'success', message: 'Registration successful' };
  } catch (error) {
    Logger.log("Registration error: " + error);
    return { status: 'error', message: 'Registration failed' };
  }
}

// Retrieve or create a sheet
function getSheet(sheetName, createIfMissing = false) {
  const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
  let sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet && createIfMissing) {
    sheet = spreadsheet.insertSheet(sheetName);
    sheet.appendRow(['username', 'password']);
  }
  return sheet;
}
